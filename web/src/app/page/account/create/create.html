<form class="create-account-form" [formGroup]="accountForm" (ngSubmit)="onSubmit()">
  <mat-card>
    <mat-card-header>
      <mat-card-title i18n="@@createAccount.title">Create Account</mat-card-title>
      <mat-card-subtitle i18n="@@createAccount.subtitle">Please fill in your personal information</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.firstName.label">First Name</mat-label>
          <input matInput formControlName="firstName" placeholder="Enter your first name" i18n-placeholder="@@createAccount.firstName.placeholder">
          @if (accountForm.get('firstName')?.hasError('required')) {
            <mat-error i18n="@@createAccount.firstName.required">First name is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.lastName.label">Last Name</mat-label>
          <input matInput formControlName="lastName" placeholder="Enter your last name" i18n-placeholder="@@createAccount.lastName.placeholder">
          @if (accountForm.get('lastName')?.hasError('required')) {
            <mat-error i18n="@@createAccount.lastName.required">Last name is required</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.gender.label">Gender</mat-label>
          <mat-select formControlName="gender">
            <mat-option value="" i18n="@@createAccount.gender.select">Select your gender</mat-option>
            @for (option of genderOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (accountForm.get('gender')?.hasError('required')) {
            <mat-error i18n="@@createAccount.gender.required">Gender is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.title.label">Title</mat-label>
          <mat-select formControlName="title">
            <mat-option value="" i18n="@@createAccount.title.select">Select your title</mat-option>
            @for (option of titleOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (accountForm.get('title')?.hasError('required')) {
            <mat-error i18n="@@createAccount.title.required">Title is required</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Legal name checkbox -->
      <div class="form-row">
        <mat-checkbox [formControl]="legalNameDifferent" i18n="@@createAccount.legalNameDifferent.label">
          My legal name and/or gender is different
        </mat-checkbox>
      </div>

      <!-- Legal name fields - shown when checkbox is checked -->
      @if (accountForm.get('legalNameDifferent')?.value) {
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label i18n="@@createAccount.legalFirstName.label">Legal First Name</mat-label>
            <input matInput formControlName="legalFirstName" placeholder="Enter your legal first name" i18n-placeholder="@@createAccount.legalFirstName.placeholder">
            @if (accountForm.get('legalFirstName')?.hasError('required')) {
              <mat-error i18n="@@createAccount.legalFirstName.required">Legal first name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label i18n="@@createAccount.legalLastName.label">Legal Last Name</mat-label>
            <input matInput formControlName="legalLastName" placeholder="Enter your legal last name" i18n-placeholder="@@createAccount.legalLastName.placeholder">
            @if (accountForm.get('legalLastName')?.hasError('required')) {
              <mat-error i18n="@@createAccount.legalLastName.required">Legal last name is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label i18n="@@createAccount.legalGender.label">Legal Gender</mat-label>
            <mat-select formControlName="legalGender">
              <mat-option value="" i18n="@@createAccount.legalGender.select">Select your legal gender</mat-option>
              @for (option of genderOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
            @if (accountForm.get('legalGender')?.hasError('required')) {
              <mat-error i18n="@@createAccount.legalGender.required">Legal gender is required</mat-error>
            }
          </mat-form-field>
        </div>
      }

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.dateOfBirth.label">Date of Birth</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="dateOfBirth">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          @if (accountForm.get('dateOfBirth')?.hasError('required')) {
            <mat-error i18n="@@createAccount.dateOfBirth.required">Date of birth is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.country.label">Country</mat-label>
          <mat-select formControlName="country">
            <mat-option value="" i18n="@@createAccount.country.select">Select your country</mat-option>
            @for (option of countryOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (accountForm.get('country')?.hasError('required')) {
            <mat-error i18n="@@createAccount.country.required">Country is required</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.email.label">Email</mat-label>
          <input matInput formControlName="email" type="email" placeholder="Enter your email address" i18n-placeholder="@@createAccount.email.placeholder">
          @if (accountForm.get('email')?.hasError('required')) {
            <mat-error i18n="@@createAccount.email.required">Email is required</mat-error>
          }
          @if (accountForm.get('email')?.hasError('email')) {
            <mat-error i18n="@@createAccount.email.invalid">Please enter a valid email address</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.password.label">Password</mat-label>
          <input matInput formControlName="password" type="password" placeholder="Enter your password" i18n-placeholder="@@createAccount.password.placeholder">
          @if (accountForm.get('password')?.hasError('required')) {
            <mat-error i18n="@@createAccount.password.required">Password is required</mat-error>
          }
          @if (accountForm.get('password')?.hasError('passwordTooWeak')) {
            <mat-error i18n="@@createAccount.password.tooWeak">Password is too weak. Please choose a stronger password.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.repeatPassword.label">Repeat Password</mat-label>
          <input matInput formControlName="repeatPassword" type="password" placeholder="Repeat your password" i18n-placeholder="@@createAccount.repeatPassword.placeholder">
          @if (accountForm.get('repeatPassword')?.hasError('required')) {
            <mat-error i18n="@@createAccount.repeatPassword.required">Please repeat your password</mat-error>
          }
          @if (accountForm.hasError('passwordMismatch')) {
            <mat-error i18n="@@createAccount.repeatPassword.mismatch">Passwords do not match</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Password strength indicator -->
      @if (ratingMessage) {
        <div class="form-row password-strength">
          <div class="strength-indicator">
            <span class="strength-label" i18n="@@createAccount.password.strength">Password Strength:</span>
            <span class="strength-value" [ngClass]="'strength-' + passwordStrength">{{ ratingMessage }}</span>
          </div>
        </div>
      }

      <!-- TOTP QR Code Section -->
      @if (totp && accountForm.get('email')?.value) {
        <div class="form-row totp-section">
          <div class="totp-container">
            <h3 i18n="@@createAccount.totp.title">Two-Factor Authentication Setup</h3>
            <p i18n="@@createAccount.totp.description">
              Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.) to set up two-factor authentication.
            </p>
            <div class="qr-code-container">
              <canvas #qrCodeCanvas></canvas>
            </div>
            <div class="totp-info">
              <p><strong i18n="@@createAccount.totp.issuer">Issuer:</strong> {{ totpIssuer }}</p>
              <p><strong i18n="@@createAccount.totp.account">Account:</strong> {{ accountForm.get('email')?.value }}</p>
            </div>
          </div>
        </div>
      }

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label i18n="@@createAccount.identityVerificationInfo.label">Identity Verification Information</mat-label>
          <textarea matInput
                    formControlName="identityVerificationInfo"
                    placeholder="Enter links, references, or other information to prove your identity (optional)"
                    i18n-placeholder="@@createAccount.identityVerificationInfo.placeholder"
                    rows="4">
          </textarea>
          <mat-hint i18n="@@createAccount.identityVerificationInfo.hint">
            You can include links to social media profiles, personal websites, or other verifiable information that helps establish your identity.
          </mat-hint>
        </mat-form-field>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-raised-button color="primary" type="submit" [disabled]="accountForm.invalid" i18n="@@createAccount.submit">
        Create Account
      </button>
    </mat-card-actions>
  </mat-card>
</form>
